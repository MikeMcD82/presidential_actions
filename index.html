<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Presidential Actions (@M_McDonough Automation Experiment)</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-96WRJNJ5NH"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-96WRJNJ5NH');
  </script>

  <!-- BOOTSTRAP 5 (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <!-- Bootstrap Icons -->
  <link 
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />
  <!-- DataTables + Bootstrap Integration (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
  />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* The first column is for toggling child rows */
    td.details-control {
      cursor: pointer;
      text-align: center;
    }
    th:nth-child(1), td:nth-child(1) {
      width: 60px;
      text-align: center;
    }
    /* Let the chart fill the parent's height */
    .chart-container {
      position: relative;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container my-4">
    <h1 class="mb-4 text-center">Presidential Actions (@M_McDonough Automation Experiment)</h1>

    <!-- The main DataTable -->
    <table id="actionsTable" class="table table-striped table-hover align-middle" style="width:100%">
      <thead>
        <tr>
          <th>AI</th>
          <th>Title</th>
          <th>AI-Identified Topics</th>
          <th>Posted</th>
          <th>Link</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Two bar charts side by side -->
    <div class="row mt-5">
      <!-- Left column: daily bar chart -->
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Actions Posted by Day</h5>
          </div>
          <!-- fix the card-body to 400px so chart doesn't expand infinitely -->
          <div class="card-body" style="height: 400px;">
            <div class="chart-container">
              <canvas id="dailyChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Right column: hour-of-day chart -->
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Time of Day Posted</h5>
          </div>
          <div class="card-body" style="height: 400px;">
            <div class="chart-container">
              <canvas id="hourChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOOTSTRAP 5 (JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables + Bootstrap Integration (JS) -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
    // Base URL for your JSON
    const DATA_URL = "https://whpresidentialactionsjsons.s3.us-east-1.amazonaws.com/gpt_responses.json";

    // dailyCounts => 'YYYY-MM-DD' => integer
    let dailyCounts = {};
    let minDate = null; // earliest action date

    // hourBins => 0..23
    let hourBins = new Array(24).fill(0);

    // Regex parse for e.g. "January 24, 2025 at 08:09 PM"
    function parsePostedDate(str) {
      const match = str.match(/^([A-Za-z]+)\s+(\d{1,2}),\s+(\d{4})\s+at\s+(\d{1,2}):(\d{2})\s+(AM|PM)$/);
      if (!match) return null;

      const monthNames = [
        "january","february","march","april","may","june",
        "july","august","september","october","november","december"
      ];
      const monthIndex = monthNames.indexOf(match[1].toLowerCase());
      if (monthIndex < 0) return null;

      let day = parseInt(match[2], 10);
      let year = parseInt(match[3], 10);
      let hour = parseInt(match[4], 10);
      let minute = parseInt(match[5], 10);
      let ampm = match[6].toUpperCase();

      if (ampm === "PM" && hour < 12) hour += 12;
      if (ampm === "AM" && hour === 12) hour = 0;

      return new Date(year, monthIndex, day, hour, minute, 0, 0);
    }

    function formatDateKey(dt) {
      let y = dt.getFullYear();
      let m = String(dt.getMonth() + 1).padStart(2, "0");
      let d = String(dt.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    // Collapsible child row for AI Analysis
    function formatChildRow(d) {
      if (!d.analysisHidden) return "<em>No Analysis</em>";
      let safeText = d.analysisHidden
        .replace(/[&<>]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;" }[c]))
        .replace(/^\s+/, "")
        .replace(/\n(\d+\)\s)/g, "<br>$1")
        .replace(/\n/g, "<br>");
      return `
        <div style="text-align:left;">
          <strong>AI Analysis:</strong><br>
          ${safeText}
        </div>
      `;
    }

    // Cache-busting parameter
    const nocacheParam = `?nocache=${Date.now()}`;
    fetch(DATA_URL + nocacheParam)  // <--- cache-busting here
      .then(resp => resp.json())
      .then(data => {
        const rowData = [];
        Object.entries(data).forEach(([actionLink, item]) => {
          let dt = parsePostedDate(item.date || "");
          if (dt) {
            // track minDate
            if (!minDate || dt < minDate) {
              minDate = dt;
            }

            // daily aggregator
            let dateKey = formatDateKey(dt);
            if (!dailyCounts[dateKey]) {
              dailyCounts[dateKey] = 0;
            }
            dailyCounts[dateKey]++;

            // hour aggregator
            let hr = dt.getHours();
            hourBins[hr]++;
          }

          let topicVal = item.topic || "Other";
          // remove "Topical Classification:" ignoring case
          topicVal = topicVal.replace(/topical classification:\s*/i, "").trim();

          let msVal = dt ? dt.valueOf() : 0;

          rowData.push({
            title: item.title || "Unknown",
            topic: topicVal,
            postedDisplay: item.date || "Unknown",
            postedSort: msVal,
            linkUrl: actionLink.startsWith("http") ? actionLink : null,
            linkText: actionLink.startsWith("http") ? "WH.gov" : "None",
            analysisHidden: item.analysis || null
          });
        });

        // Fill zero-action days up to "today"
        if (minDate) {
          let dayCursor = new Date(minDate);
          dayCursor.setHours(0,0,0,0);
          // We'll end on today's date
          let endDate = new Date();
          endDate.setHours(0,0,0,0);

          while (dayCursor <= endDate) {
            let key = formatDateKey(dayCursor);
            if (!dailyCounts[key]) {
              dailyCounts[key] = 0;
            }
            dayCursor.setDate(dayCursor.getDate() + 1);
          }
        }

        // Initialize DataTable
        const table = $("#actionsTable").DataTable({
          data: rowData,
          columns: [
            {
              className: "details-control",
              orderable: false,
              data: null,
              defaultContent: `
                <span class="text-primary fw-bold"
                  data-bs-toggle="tooltip"
                  title="Click to reveal AI Analysis"
                >
                  <i class="bi bi-plus-circle"></i>
                </span>
              `
            },
            { data: "title", title: "Title" },
            { data: "topic", title: "AI-Identified Topics" },
            {
              data: "postedDisplay",
              title: "Posted",
              render: (val, type, row) => {
                if (type === "sort") {
                  return row.postedSort;
                }
                return val;
              }
            },
            {
              data: null,
              title: "Link",
              render: (rd, type, row) => {
                if (!row.linkUrl) return "None";
                return `
                  <a
                    href="${row.linkUrl}"
                    target="_blank"
                    class="text-decoration-none"
                    data-bs-toggle="tooltip"
                    title="Open the official action on WhiteHouse.gov"
                  >
                    <i class="bi bi-box-arrow-up-right"></i> ${row.linkText}
                  </a>
                `;
              }
            },
            {
              data: "analysisHidden",
              visible: false,
              searchable: true
            }
          ],
          order: [[3, "desc"]],
          responsive: true
        });

        // Expand/collapse AI Analysis
        $("#actionsTable tbody").on("click", "td.details-control", function() {
          const tr = $(this).closest("tr");
          const row = table.row(tr);

          const iconEl = this.querySelector("[data-bs-toggle='tooltip']");
          if (iconEl) {
            const tooltipInstance = bootstrap.Tooltip.getInstance(iconEl);
            if (tooltipInstance) {
              tooltipInstance.hide();
            }
          }

          if (row.child.isShown()) {
            row.child.hide();
            tr.removeClass("shown");
            $(this).html(`
              <span class="text-primary fw-bold"
                data-bs-toggle="tooltip"
                title="Click to reveal AI Analysis"
              >
                <i class="bi bi-plus-circle"></i>
              </span>
            `);
          } else {
            row.child(formatChildRow(row.data())).show();
            tr.addClass("shown");
            $(this).html(`
              <span class="text-danger fw-bold"
                data-bs-toggle="tooltip"
                title="Hide AI Analysis"
              >
                <i class="bi bi-dash-circle"></i>
              </span>
            `);
          }

          var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
        });

        // Table-level tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

        // Render daily chart
        renderDailyChart(dailyCounts);
        // Render hour-of-day chart
        renderHourChart(hourBins);
      })
      .catch(err => console.error("Error fetching JSON:", err));

    function renderDailyChart(countsObj) {
      let dateKeys = Object.keys(countsObj).sort();
      let labels = [];
      let dataArr = [];

      dateKeys.forEach(k => {
        labels.push(k);
        dataArr.push(countsObj[k]);
      });

      const ctx = document.getElementById("dailyChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Actions Posted per Day",
            data: dataArr,
            backgroundColor: "rgba(255, 99, 132, 0.6)",
            borderColor: "rgba(255, 99, 132, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: "Date (YYYY-MM-DD)" }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Number of Actions" }
            }
          }
        }
      });
    }

    function renderHourChart(hourBins) {
      const ctx = document.getElementById("hourChart").getContext("2d");
      const labels = [...Array(24).keys()].map(String);

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Actions by Hour",
            data: hourBins,
            backgroundColor: "rgba(54, 162, 235, 0.6)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: "Hour of Day (Local Time)" }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Number of Actions" }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
