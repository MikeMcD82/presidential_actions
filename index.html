<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Presidential Actions (@M_McDonough Automation Experiment)</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-96WRJNJ5NH"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-96WRJNJ5NH');
  </script>

  <!-- BOOTSTRAP 5 (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <!-- Bootstrap Icons (for plus/minus icons) -->
  <link 
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />
  <!-- DataTables + Bootstrap Integration (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
  />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* The first column is for toggling child rows */
    td.details-control {
      cursor: pointer;
      text-align: center;
    }
    th:nth-child(1), td:nth-child(1) {
      width: 60px;
      text-align: center;
    }

    /* Make the chart container flexible while maintaining aspect ratio */
    .chart-container {
      position: relative;
      width: 100%;
    }
    /* If you want a custom aspect ratio, you can do something like: 
       .chart-container {
         position: relative;
         width: 100%;
         height: 400px; 
       } 
       Then set: maintainAspectRatio: false in Chart.js
    */
  </style>
</head>
<body class="bg-light">
  <div class="container my-4">
    <h1 class="mb-4 text-center">Presidential Actions (@M_McDonough Automation Experiment)</h1>

    <!-- The main DataTable -->
    <table
      id="actionsTable"
      class="table table-striped table-hover align-middle"
      style="width:100%"
    >
      <thead>
        <tr>
          <th>AI</th> <!-- plus/minus toggle column -->
          <th>Title</th>
          <th>AI-Identified Topics</th>
          <th>Posted</th>
          <th>Link</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- A row for the chart card -->
    <div class="row mt-5">
      <div class="col-md-8 offset-md-2">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title mb-0">Time of Day Posted</h3>
          </div>
          <div class="card-body">
            <p class="small text-muted">
              This bar chart shows how many actions are posted during each hour of the day (local time).
            </p>
            <!-- The responsive chart container -->
            <div class="chart-container">
              <canvas id="hourChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOOTSTRAP 5 (JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables + Bootstrap Integration (JS) -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
    const DATA_URL = "https://whpresidentialactionsjsons.s3.us-east-1.amazonaws.com/gpt_responses.json";
    const hourBins = new Array(24).fill(0);

    function parsePostedDate(str) {
      // Regex approach for "January 24, 2025 at 08:09 PM"
      const match = str.match(/^([A-Za-z]+)\s+(\d{1,2}),\s+(\d{4})\s+at\s+(\d{1,2}):(\d{2})\s+(AM|PM)$/);
      if (!match) {
        return null;
      }
      const monthNames = [
        "january","february","march","april","may","june",
        "july","august","september","october","november","december"
      ];
      const monthIndex = monthNames.indexOf(match[1].toLowerCase());
      if (monthIndex < 0) return null;

      let day = parseInt(match[2], 10);
      let year = parseInt(match[3], 10);
      let hour = parseInt(match[4], 10);
      let minute = parseInt(match[5], 10);
      let ampm = match[6].toUpperCase();

      // 12hr to 24hr
      if (ampm === "PM" && hour < 12) hour += 12;
      if (ampm === "AM" && hour === 12) hour = 0;

      return new Date(year, monthIndex, day, hour, minute, 0, 0);
    }

    function formatChildRow(d) {
      if (!d.analysisHidden) {
        return "<em>No Analysis</em>";
      }
      const safeText = d.analysisHidden
        .replace(/[&<>]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;" }[c]))
        .replace(/^\s+/, "")
        .replace(/\n(\d+\)\s)/g, "<br>$1")
        .replace(/\n/g, "<br>");
      return `
        <div style="text-align:left;">
          <strong>AI Analysis:</strong><br>${safeText}
        </div>
      `;
    }

    fetch(DATA_URL)
      .then(resp => resp.json())
      .then(data => {
        const rowData = [];
        Object.entries(data).forEach(([actionLink, item]) => {
          const dt = parsePostedDate(item.date || "");
          let postedMs = null;
          if (dt) {
            postedMs = dt.valueOf();
            // increment the hour bin
            const hr = dt.getHours();
            hourBins[hr]++;
          }

          let topicVal = item.topic || "Other";
          // drop "Topical Classification:" ignoring case
          topicVal = topicVal.replace(/topical classification:\s*/i, "").trim();

          rowData.push({
            title: item.title || "Unknown",
            topic: topicVal,
            postedDisplay: item.date || "Unknown",
            postedSort: postedMs, // numeric for sorting
            linkUrl: actionLink.startsWith("http") ? actionLink : null,
            linkText: actionLink.startsWith("http") ? "WH.gov" : "None",
            analysisHidden: item.analysis || null
          });
        });

        // Build DataTable
        const table = $("#actionsTable").DataTable({
          data: rowData,
          columns: [
            {
              className: "details-control",
              orderable: false,
              data: null,
              defaultContent: `
                <span class="text-primary fw-bold"
                  data-bs-toggle="tooltip"
                  title="Click to reveal AI Analysis"
                >
                  <i class="bi bi-plus-circle"></i>
                </span>
              `
            },
            { data: "title", title: "Title" },
            { data: "topic", title: "AI-Identified Topics" },
            {
              data: "postedDisplay",
              title: "Posted",
              render: (val, type, row) => {
                if (type === "sort") {
                  return row.postedSort || 0;
                }
                return val;
              }
            },
            {
              data: null,
              title: "Link",
              render: (rowData, type, row) => {
                if (!row.linkUrl) return "None";
                return `
                  <a
                    href="${row.linkUrl}"
                    target="_blank"
                    class="text-decoration-none"
                    data-bs-toggle="tooltip"
                    title="Open the official action on WhiteHouse.gov"
                  >
                    <i class="bi bi-box-arrow-up-right"></i> ${row.linkText}
                  </a>
                `;
              }
            },
            {
              // hidden analysis column
              data: "analysisHidden",
              visible: false,
              searchable: true
            }
          ],
          order: [[3, "desc"]],
          responsive: true
        });

        // Expand/collapse AI Analysis
        $("#actionsTable tbody").on("click", "td.details-control", function() {
          const tr = $(this).closest("tr");
          const row = table.row(tr);

          const iconEl = this.querySelector("[data-bs-toggle='tooltip']");
          if (iconEl) {
            const tooltipInstance = bootstrap.Tooltip.getInstance(iconEl);
            if (tooltipInstance) tooltipInstance.hide();
          }

          if (row.child.isShown()) {
            row.child.hide();
            tr.removeClass("shown");
            $(this).html(`
              <span class="text-primary fw-bold"
                data-bs-toggle="tooltip"
                title="Click to reveal AI Analysis"
              >
                <i class="bi bi-plus-circle"></i>
              </span>
            `);
          } else {
            row.child(formatChildRow(row.data())).show();
            tr.addClass("shown");
            $(this).html(`
              <span class="text-danger fw-bold"
                data-bs-toggle="tooltip"
                title="Hide AI Analysis"
              >
                <i class="bi bi-dash-circle"></i>
              </span>
            `);
          }

          var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
        });

        // Initialize table tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(el => new bootstrap.Tooltip(el));

        // Render the bar chart with the hourBins
        renderHourChart(hourBins);
      })
      .catch(err => console.error("Error fetching JSON:", err));

    // Actually build the Chart.js bar chart
    function renderHourChart(hourBins) {
      const ctx = document.getElementById("hourChart").getContext("2d");
      const labels = [...Array(24).keys()].map(String); // "0".."23"

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Actions by Hour",
              data: hourBins,
              backgroundColor: "rgba(54, 162, 235, 0.6)",
              borderColor: "rgba(54, 162, 235, 1)",
              borderWidth: 1
            }
          ]
        },
        options: {
          maintainAspectRatio: true,
          scales: {
            x: {
              title: {
                display: true,
                text: "Hour of Day (Local)"
              }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Number of Actions"
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
