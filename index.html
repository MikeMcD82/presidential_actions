<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Presidential Actions - A @M_McDonough Experiment</title>

  <!-- BOOTSTRAP 5 (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />

  <!-- DataTables + Bootstrap Integration (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
  />

  <!-- Bootstrap Icons (Optional) -->
  <link 
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />

  <!-- jQuery UI CSS (for the slider) -->
  <link 
    rel="stylesheet"
    href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* [A] Minimal slider styling overrides */
    .ui-slider-horizontal {
      height: 0.4rem;  /* a bit taller track than default */
      border-radius: 0.2rem;
      background: #eee; /* light gray base track */
    }
    .ui-slider-horizontal .ui-slider-handle {
      border: 2px solid #0d6efd; /* use Bootstrap's primary color */
      background: #fff;
      width: 1.4rem;
      height: 1.4rem;
      border-radius: 50%;
      top: -0.55rem; /* vertically center the handle on track */
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    .ui-slider-horizontal .ui-slider-range {
      background: #0d6efd;
      border-radius: 0.2rem;
    }
    /* Hover/active states for the handle */
    .ui-slider-horizontal .ui-state-hover,
    .ui-slider-horizontal .ui-state-active {
      outline: none;
    }

    /* The first column is for toggling child rows in the table */
    td.details-control {
      cursor: pointer;
      text-align: center;
    }
    th:nth-child(1), td:nth-child(1) {
      width: 60px;
      text-align: center;
    }
    /* Let charts fill their container properly */
    .chart-container {
      position: relative;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body class="bg-light">
<div class="container my-4">

  <h1 class="mb-4 text-center">Presidential Actions - A @M_McDonough Experiment</h1>

  <!-- Range Slider Card -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0">Filter by Posting Date</h5>
    </div>
    <div class="card-body">
      <div id="slider-range"></div>
      <div class="mt-2">
        Showing posts from
        <span id="sliderMin" class="fw-bold"></span>
        to
        <span id="sliderMax" class="fw-bold"></span>
      </div>
    </div>
  </div>

  <!-- Main DataTable -->
  <table id="actionsTable" class="table table-striped table-hover align-middle" style="width:100%">
    <thead>
      <tr>
        <th>AI</th>
        <th>Title</th>
        <th>AI-Identified Topics</th>
        <th>Posted</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Row of bar charts -->
  <div class="row mt-5">
    <div class="col-md-6 mb-3">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Actions Posted by Day</h5>
        </div>
        <div class="card-body" style="height: 400px;">
          <div class="chart-container">
            <canvas id="dailyChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-3">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Time of Day Posted</h5>
        </div>
        <div class="card-body" style="height: 400px;">
          <div class="chart-container">
            <canvas id="hourChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- BOOTSTRAP 5 (JS) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- jQuery UI JS (for slider) -->
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<!-- DataTables + Bootstrap Integration (JS) -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
  // Base URL for your JSON
  const DATA_URL = "https://whpresidentialactionsjsons.s3.us-east-1.amazonaws.com/gpt_responses.json";

  let dailyCounts = {};
  let minDate = null, maxDate = null; // track earliest, latest full Date objs
  let rowData = [];
  let hourBins = new Array(24).fill(0);

  let minTS = Infinity;  // earliest UNIX timestamp among actions
  let maxTS = -Infinity; // latest UNIX timestamp
  let table;             // DataTable reference
  let sliderMin, sliderMax; // keep track of current slider bounds

  // Convert Unix timestamp to "YYYY-MM-DD HH:mm"
  function formatUnixDateTime(unixTs) {
    const d = new Date(unixTs);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }

  // Expand/collapse row child content
  function formatChildRow(d) {
    if (!d.analysisHidden) return "<em>No Analysis</em>";
    let safeText = d.analysisHidden
      .replace(/[&<>]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;" }[c]))
      .replace(/^\s+/, "")
      .replace(/\n(\d+\)\s)/g, "<br>$1")
      .replace(/\n/g, "<br>");
    return `
      <div style="text-align:left;">
        <strong>AI Analysis:</strong><br>
        ${safeText}
      </div>
    `;
  }

  // Cache-busting param
  const nocacheParam = `?nocache=${Date.now()}`;
  fetch(DATA_URL + nocacheParam)
    .then(r => r.json())
    .then(data => {
      Object.entries(data).forEach(([link, item]) => {
        let dt = new Date(item.date_unix);
        if (dt) {
          if (!minDate || dt < minDate) minDate = dt;
          if (!maxDate || dt > maxDate) maxDate = dt;

          let msVal = dt.valueOf();
          if (msVal < minTS) minTS = msVal;
          if (msVal > maxTS) maxTS = msVal;

          // daily counts
          let datePart = formatUnixDateTime(msVal).split(" ")[0];
          dailyCounts[datePart] = (dailyCounts[datePart] || 0) + 1;

          // hour aggregator
          let hr = dt.getHours();
          hourBins[hr]++;
        }

        let topic = (item.topic || "Other")
          .replace(/topical classification:\s*/i, "")
          .trim();

        rowData.push({
          title: item.title || "Unknown",
          topic,
          postedDisplay: dt ? formatUnixDateTime(dt.valueOf()) : "",
          postedSort: dt ? dt.valueOf() : 0,
          linkUrl: link.startsWith("http") ? link : null,
          linkText: link.startsWith("http") ? "WH.gov" : "None",
          analysisHidden: item.analysis || null
        });
      });

      // Fill zero-action days up to "today"
      if (minDate) {
        let dayCursor = new Date(minDate);
        dayCursor.setHours(0,0,0,0);
        const endDate = new Date();
        endDate.setHours(0,0,0,0);
        while (dayCursor <= endDate) {
          let key = formatUnixDateTime(dayCursor).split(" ")[0];
          if (!dailyCounts[key]) {
            dailyCounts[key] = 0;
          }
          dayCursor.setDate(dayCursor.getDate()+1);
        }
      }

      // Initialize DataTable
      table = $("#actionsTable").DataTable({
        data: rowData,
        columns: [
          {
            className: "details-control",
            orderable: false,
            data: null,
            defaultContent: `
              <span class="text-primary fw-bold"
                data-bs-toggle="tooltip"
                title="Click to reveal AI Analysis"
              >
                <i class="bi bi-plus-circle"></i>
              </span>
            `
          },
          { data: "title", title: "Title" },
          { data: "topic", title: "AI-Identified Topics" },
          {
            data: "postedSort",
            title: "Posted",
            type: "num",
            render: (val, type, row) => {
              if (type === "sort") return val;
              return row.postedDisplay;
            }
          },
          {
            data: null,
            title: "Link",
            render: (rd, type, row) => {
              if (!row.linkUrl) return "None";
              return `
                <a
                  href="${row.linkUrl}"
                  target="_blank"
                  class="text-decoration-none"
                  data-bs-toggle="tooltip"
                  title="Open the official action on WhiteHouse.gov"
                >
                  <i class="bi bi-box-arrow-up-right"></i> ${row.linkText}
                </a>
              `;
            }
          },
          {
            data: "analysisHidden",
            visible: false,
            searchable: true
          }
        ],
        order: [[3, "desc"]], // newest to oldest
        responsive: true
      });

      // Collapsible row
      $("#actionsTable tbody").on("click", "td.details-control", function() {
        const tr = $(this).closest("tr");
        const row = table.row(tr);

        // hide tooltip if open
        const iconEl = this.querySelector("[data-bs-toggle='tooltip']");
        if (iconEl) {
          const tipInst = bootstrap.Tooltip.getInstance(iconEl);
          if (tipInst) tipInst.hide();
        }

        if (row.child.isShown()) {
          row.child.hide();
          tr.removeClass("shown");
          $(this).html(`
            <span class="text-primary fw-bold"
              data-bs-toggle="tooltip"
              title="Click to reveal AI Analysis"
            >
              <i class="bi bi-plus-circle"></i>
            </span>
          `);
        } else {
          row.child(formatChildRow(row.data())).show();
          tr.addClass("shown");
          $(this).html(`
            <span class="text-danger fw-bold"
              data-bs-toggle="tooltip"
              title="Hide AI Analysis"
            >
              <i class="bi bi-dash-circle"></i>
            </span>
          `);
        }
        let tips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tips.map(el => new bootstrap.Tooltip(el));
      });

      // Initialize tooltips
      let tips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tips.map(el => new bootstrap.Tooltip(el));

      // ~~~~~~~~~~~~~~~~~~~~~ SLIDER & FILTER ~~~~~~~~~~~~~~~~~~~~~
      sliderMin = minTS;
      sliderMax = maxTS;

      // Custom filter: only show rows whose postedSort is in [sliderMin, sliderMax]
      $.fn.dataTable.ext.search.push(function(settings, rowData_, dataIndex){
        const rowObj = table.row(dataIndex).data();
        const t = rowObj.postedSort;
        return (t >= sliderMin && t <= sliderMax);
      });

      // Initialize jQuery UI slider
      $("#slider-range").slider({
        range: true,
        min: minTS,
        max: maxTS,
        values: [minTS, maxTS],
        slide: function(e, ui){
          sliderMin = ui.values[0];
          sliderMax = ui.values[1];

          // Display friendly date (YYYY-MM-DD) for each slider handle
          $("#sliderMin").text( formatUnixDateTime(sliderMin).split(" ")[0] );
          $("#sliderMax").text( formatUnixDateTime(sliderMax).split(" ")[0] );

          // Re-draw table with updated filter
          table.draw();
        }
      });

      // Set initial text
      $("#sliderMin").text( formatUnixDateTime(minTS).split(" ")[0] );
      $("#sliderMax").text( formatUnixDateTime(maxTS).split(" ")[0] );

      // ~~~~~~~~~~~~~~~~~~~~~ CHARTS ~~~~~~~~~~~~~~~~~~~~~
      renderDailyChart(dailyCounts);
      renderHourChart(hourBins);
    })
    .catch(err => console.error("Error fetching JSON:", err));


  function renderDailyChart(countsObj) {
    const dateKeys = Object.keys(countsObj).sort();
    let labels = [];
    let dataArr = [];
    dateKeys.forEach(k => {
      labels.push(k);
      dataArr.push(countsObj[k]);
    });

    const ctx = document.getElementById("dailyChart").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Actions Posted per Day",
          data: dataArr,
          backgroundColor: "rgba(255, 99, 132, 0.6)",
          borderColor: "rgba(255, 99, 132, 1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: "Date (YYYY-MM-DD)" }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: "Number of Actions" }
          }
        }
      }
    });
  }

  function renderHourChart(hourBins) {
    const ctx = document.getElementById("hourChart").getContext("2d");
    const labels = [...Array(24).keys()].map(String);

    new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Actions by Hour",
          data: hourBins,
          backgroundColor: "rgba(54, 162, 235, 0.6)",
          borderColor: "rgba(54, 162, 235, 1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: "Hour of Day (Local)" }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: "Number of Actions" }
          }
        }
      }
    });
  }
</script>
</body>
</html>
