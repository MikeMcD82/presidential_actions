<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Presidential Actions - A @M_McDonough Experiment</title>

  <!-- BOOTSTRAP 5 (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />

  <!-- DataTables + Bootstrap Integration (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
  />

  <!-- jQuery UI CSS (for the slider) -->
  <link
    rel="stylesheet"
    href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- (Optional) Bootstrap Icons -->
  <link 
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />

  <style>
    /* The first column is for toggling child rows */
    td.details-control {
      cursor: pointer;
      text-align: center;
    }
    th:nth-child(1), td:nth-child(1) {
      width: 60px;
      text-align: center;
    }

    /* Let the chart fill the parent's height */
    .chart-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    /* Slider style overrides to match Bootstrap-ish design */
    .ui-slider-horizontal {
      height: 0.4rem;
      border-radius: 0.2rem;
      background: #eee;
    }
    .ui-slider-horizontal .ui-slider-range {
      background: #0d6efd; /* Bootstrap primary */
      border-radius: 0.2rem;
    }
    .ui-slider-horizontal .ui-slider-handle {
      border: 2px solid #0d6efd;
      background: #fff;
      width: 1.4rem;
      height: 1.4rem;
      border-radius: 50%;
      top: -0.55rem;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body class="bg-light">
<div class="container my-4">

  <h1 class="mb-4 text-center">Presidential Actions - A @M_McDonough Experiment</h1>

  <!-- Range Slider Card -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0">Filter by Posting Date</h5>
    </div>
    <div class="card-body">
      <div id="slider-range"></div>
      <div class="mt-2">
        Showing posts from
        <span id="sliderMin" class="fw-bold"></span>
        to
        <span id="sliderMax" class="fw-bold"></span>
      </div>
    </div>
  </div>

  <!-- The main DataTable -->
  <table id="actionsTable" class="table table-striped table-hover align-middle" style="width:100%">
    <thead>
      <tr>
        <th>AI</th>
        <th>Title</th>
        <th>AI-Identified Topics</th>
        <th>Posted</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Two bar charts side by side -->
  <div class="row mt-5">
    <!-- Left column: daily bar chart -->
    <div class="col-md-6 mb-3">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Actions Posted by Day (Filtered)</h5>
        </div>
        <div class="card-body" style="height: 400px;">
          <div class="chart-container">
            <canvas id="dailyChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Right column: hour-of-day chart -->
    <div class="col-md-6 mb-3">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Time of Day Posted (Filtered)</h5>
        </div>
        <div class="card-body" style="height: 400px;">
          <div class="chart-container">
            <canvas id="hourChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- BOOTSTRAP 5 (JS) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- jQuery UI JS (for slider) -->
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<!-- DataTables + Bootstrap Integration (JS) -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
  // Base URL for your JSON
  const DATA_URL = "https://whpresidentialactionsjsons.s3.us-east-1.amazonaws.com/gpt_responses.json";

  let rowData = [];
  let minTS = Infinity;
  let maxTS = -Infinity;
  let table;
  let sliderMin, sliderMax;

  // We'll store references to Chart.js instances:
  let dailyChart, hourChart;

  // Utility: convert Unix timestamp -> "YYYY-MM-DD HH:mm"
  function formatUnixDateTime(unixTs) {
    const d = new Date(unixTs);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }

  // Expand/collapse row child content
  function formatChildRow(d) {
    if (!d.analysisHidden) return "<em>No Analysis</em>";
    let safeText = d.analysisHidden
      .replace(/[&<>]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;" }[c]))
      .replace(/^\s+/, "")
      .replace(/\n(\d+\)\s)/g, "<br>$1")
      .replace(/\n/g, "<br>");
    return `
      <div style="text-align:left;">
        <strong>AI Analysis:</strong><br>
        ${safeText}
      </div>
    `;
  }

  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  //  1) FETCH JSON, PARSE, & INIT DATATABLE / CHARTS
  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  fetch(DATA_URL + `?nocache=${Date.now()}`)
    .then(resp => resp.json())
    .then(data => {
      // Build rowData array
      Object.entries(data).forEach(([link, item]) => {
        const dt = new Date(item.date_unix);
        const ts = dt.valueOf();
        if (ts < minTS) minTS = ts;
        if (ts > maxTS) maxTS = ts;

        // Clean up the topic text
        let topicVal = item.topic || "Other";
        topicVal = topicVal.replace(/topical classification:\s*/i, "").trim();

        rowData.push({
          title: item.title || "Unknown",
          topic: topicVal,
          postedDisplay: formatUnixDateTime(ts),
          postedSort: ts,
          linkUrl: link.startsWith("http") ? link : null,
          linkText: link.startsWith("http") ? "WH.gov" : "None",
          analysisHidden: item.analysis || null
        });
      });

      // Initialize the DataTable
      table = $("#actionsTable").DataTable({
        data: rowData,
        columns: [
          {
            className: "details-control",
            orderable: false,
            data: null,
            defaultContent: `
              <span class="text-primary fw-bold"
                data-bs-toggle="tooltip"
                title="Click to reveal AI Analysis"
              >
                <i class="bi bi-plus-circle"></i>
              </span>
            `
          },
          { data: "title", title: "Title" },
          { data: "topic", title: "AI-Identified Topics" },
          {
            data: "postedSort",
            title: "Posted",
            type: "num",
            render: (val, type, row) => {
              if (type === "sort") return val;
              return row.postedDisplay;
            }
          },
          {
            data: null,
            title: "Link",
            render: (rd, type, row) => {
              if (!row.linkUrl) return "None";
              return `
                <a
                  href="${row.linkUrl}"
                  target="_blank"
                  class="text-decoration-none"
                  data-bs-toggle="tooltip"
                  title="Open the official action on WhiteHouse.gov"
                >
                  <i class="bi bi-box-arrow-up-right"></i> ${row.linkText}
                </a>
              `;
            }
          },
          {
            data: "analysisHidden",
            visible: false,
            searchable: true
          }
        ],
        order: [[3, "desc"]], // sort newest -> oldest
        responsive: true
      });

      // Expand/collapse child row
      $("#actionsTable tbody").on("click", "td.details-control", function() {
        const tr = $(this).closest("tr");
        const row = table.row(tr);

        // hide tooltip if open
        const iconEl = this.querySelector("[data-bs-toggle='tooltip']");
        if (iconEl) {
          const tipInst = bootstrap.Tooltip.getInstance(iconEl);
          if (tipInst) tipInst.hide();
        }

        if (row.child.isShown()) {
          row.child.hide();
          tr.removeClass("shown");
          $(this).html(`
            <span class="text-primary fw-bold"
              data-bs-toggle="tooltip"
              title="Click to reveal AI Analysis"
            >
              <i class="bi bi-plus-circle"></i>
            </span>
          `);
        } else {
          row.child(formatChildRow(row.data())).show();
          tr.addClass("shown");
          $(this).html(`
            <span class="text-danger fw-bold"
              data-bs-toggle="tooltip"
              title="Hide AI Analysis"
            >
              <i class="bi bi-dash-circle"></i>
            </span>
          `);
        }
        let tips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tips.map(el => new bootstrap.Tooltip(el));
      });

      // Initialize tooltips
      let tips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tips.map(el => new bootstrap.Tooltip(el));

      // Create two empty charts
      dailyChart = createEmptyDailyChart();
      hourChart  = createEmptyHourChart();

      // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      //  2) CUSTOM FILTER + DATE RANGE SLIDER
      // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

      // We'll store the current slider range in sliderMin/sliderMax
      sliderMin = minTS;
      sliderMax = maxTS;

      // Custom DataTables filter that only passes rows with postedSort in [sliderMin..sliderMax]
      $.fn.dataTable.ext.search.push((settings, rowData_, dataIndex) => {
        const rowObj = table.row(dataIndex).data();
        const t = rowObj.postedSort;
        return (t >= sliderMin && t <= sliderMax);
      });

      // jQuery UI range slider
      $("#slider-range").slider({
        range: true,
        min: minTS,
        max: maxTS,
        values: [minTS, maxTS],
        slide: (evt, ui) => {
          sliderMin = ui.values[0];
          sliderMax = ui.values[1];
          $("#sliderMin").text( formatUnixDateTime(sliderMin).split(" ")[0] );
          $("#sliderMax").text( formatUnixDateTime(sliderMax).split(" ")[0] );
          table.draw(); // re-filter
        }
      });
      // Initialize slider labels
      $("#sliderMin").text( formatUnixDateTime(minTS).split(" ")[0] );
      $("#sliderMax").text( formatUnixDateTime(maxTS).split(" ")[0] );

      // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      //  3) WHEN TABLE DRAWN => RECALC & UPDATE CHARTS
      // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      table.on("draw", function() {
        updateChartsFromTable();
      });

      // On initial load, also update charts (or just call table.draw())
      updateChartsFromTable();
    })
    .catch(err => console.error("Error fetching JSON:", err));


  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  // CHART CODE
  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  function createEmptyDailyChart() {
    const ctx = document.getElementById("dailyChart").getContext("2d");
    return new Chart(ctx, {
      type: "bar",
      data: {
        labels: [],
        datasets: [{
          label: "Actions / Day",
          data: [],
          backgroundColor: "rgba(255, 99, 132, 0.6)",
          borderColor: "rgba(255, 99, 132, 1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: "Date (YYYY-MM-DD)" },
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: "Number of Actions" }
          }
        }
      }
    });
  }

  function createEmptyHourChart() {
    const ctx = document.getElementById("hourChart").getContext("2d");
    return new Chart(ctx, {
      type: "bar",
      data: {
        labels: [...Array(24).keys()].map(String),
        datasets: [{
          label: "Actions by Hour",
          data: new Array(24).fill(0),
          backgroundColor: "rgba(54, 162, 235, 0.6)",
          borderColor: "rgba(54, 162, 235, 1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: "Hour of Day (Local)" }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: "Number of Actions" }
          }
        }
      }
    });
  }

  // Re-aggregate the currently visible rows in the DataTable, then update charts
  function updateChartsFromTable() {
    // Get all displayed rows (i.e. after slider filtering, search, etc.)
    const displayedRows = table.rows({ filter: "applied" }).data();

    // Build daily aggregator => { 'YYYY-MM-DD': count }
    let dailyMap = {};
    // Build hour aggregator => array of length 24
    let hourArr = new Array(24).fill(0);

    displayedRows.each(item => {
      let dt = new Date(item.postedSort);
      let dateStr = formatUnixDateTime(dt.valueOf()).split(" ")[0];
      dailyMap[dateStr] = (dailyMap[dateStr] || 0) + 1;

      let hr = dt.getHours();
      hourArr[hr]++;
    });

    // Sort dailyMap by date
    const dailyKeys = Object.keys(dailyMap).sort();
    // Prepare arrays
    let dailyLabels = [];
    let dailyVals   = [];
    dailyKeys.forEach(k => {
      dailyLabels.push(k);
      dailyVals.push(dailyMap[k]);
    });

    // ~~~ Update dailyChart data ~~~
    dailyChart.data.labels = dailyLabels;
    dailyChart.data.datasets[0].data = dailyVals;
    dailyChart.update();

    // ~~~ Update hourChart data ~~~
    hourChart.data.datasets[0].data = hourArr;
    hourChart.update();
  }
</script>
</body>
</html>
