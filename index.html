<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Presidential Actions - A @M_McDonough Experiment</title>

  <!-- BOOTSTRAP 5 (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <!-- DataTables + Bootstrap Integration (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
  />

  <!-- noUiSlider CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.css"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- (Optional) Bootstrap Icons -->
  <link 
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />

  <style>
    /* The first column is for toggling child rows */
    td.details-control {
      cursor: pointer;
      text-align: center;
    }
    th:nth-child(1), td:nth-child(1) {
      width: 60px;
      text-align: center;
    }

    /* Let charts fill their container */
    .chart-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    /* Minimal styling for the noUiSlider container */
    #sliderRange {
      margin: 20px 0;
    }
    /* If you want to style the handles or track more, you can override default .noUi-* classes */
  </style>
</head>
<body class="bg-light">

<div class="container my-4">
  <h1 class="mb-4 text-center">Presidential Actions - A @M_McDonough Experiment</h1>

  <!-- noUiSlider Range -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0">Filter by Posting Date/Time (noUiSlider)</h5>
    </div>
    <div class="card-body">
      <div id="sliderRange"></div>
      <div class="mt-2">
        Showing posts from
        <span id="sliderMin" class="fw-bold"></span>
        to
        <span id="sliderMax" class="fw-bold"></span>
      </div>
    </div>
  </div>

  <!-- Main DataTable -->
  <table id="actionsTable" class="table table-striped table-hover align-middle" style="width:100%">
    <thead>
      <tr>
        <th>AI</th>
        <th>Title</th>
        <th>AI-Identified Topics</th>
        <th>Posted</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Row of bar charts -->
  <div class="row mt-5">
    <div class="col-md-6 mb-3">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Actions Posted by Day (Filtered)</h5>
        </div>
        <div class="card-body" style="height: 400px;">
          <div class="chart-container">
            <canvas id="dailyChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-3">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Time of Day Posted (Filtered)</h5>
        </div>
        <div class="card-body" style="height: 400px;">
          <div class="chart-container">
            <canvas id="hourChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BOOTSTRAP 5 (JS) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DataTables + Bootstrap Integration (JS) -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<!-- noUiSlider JS -->
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.0/dist/nouislider.min.js"></script>

<script>
  // URL to your JSON
  const DATA_URL = "https://whpresidentialactionsjsons.s3.us-east-1.amazonaws.com/gpt_responses.json";

  // We'll store row objects in rowData
  let rowData = [];
  // For the daily chart, we want to lock the entire date range from earliest->latest day
  let allDateLabels = [];
  // For the hour chart, we'll fix 0..23
  const hourLabels = [...Array(24).keys()].map(String);

  // track earliest / latest timestamps
  let minTS = Infinity;
  let maxTS = -Infinity;

  // references to DataTable + charts
  let table;
  let dailyChart, hourChart;

  // range slider handles
  let sliderMin, sliderMax;

  // (A) Convert a Unix ms to "YYYY-MM-DD HH:mm"
  function formatUnixDateTime(unixMs) {
    const d = new Date(unixMs);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }

  // (B) Utility to get just "YYYY-MM-DD" from a Date
  function formatYmd(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth()+1).padStart(2,"0");
    const d = String(dateObj.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }

  // Collapsible child row
  function formatChildRow(d) {
    if (!d.analysisHidden) return "<em>No Analysis</em>";
    let safeText = d.analysisHidden
      .replace(/[&<>]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;" }[c]))
      .replace(/^\s+/, "")
      .replace(/\n(\d+\)\s)/g, "<br>$1")
      .replace(/\n/g, "<br>");
    return `
      <div style="text-align:left;">
        <strong>AI Analysis:</strong><br>
        ${safeText}
      </div>
    `;
  }

  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  // 1) FETCH JSON => BUILD rowData => DETERMINE MIN/MAX => BUILD date range
  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  fetch(DATA_URL + `?nocache=${Date.now()}`)
    .then(resp => resp.json())
    .then(data => {
      // Build rowData
      Object.entries(data).forEach(([link, item]) => {
        const dt = new Date(item.date_unix);
        const ts = dt.valueOf();
        if (ts < minTS) minTS = ts;
        if (ts > maxTS) maxTS = ts;

        let topicVal = item.topic || "Other";
        topicVal = topicVal.replace(/topical classification:\s*/i, "").trim();

        rowData.push({
          title: item.title || "Unknown",
          topic: topicVal,
          postedDisplay: formatUnixDateTime(ts),
          postedSort: ts,
          linkUrl: link.startsWith("http") ? link : null,
          linkText: link.startsWith("http") ? "WH.gov" : "None",
          analysisHidden: item.analysis || null
        });
      });

      // Build locked daily date range from earliest..latest (day-level)
      let minDate = new Date(minTS); minDate.setHours(0,0,0,0);
      let maxDate = new Date(maxTS); maxDate.setHours(0,0,0,0);
      let cur = new Date(minDate);
      while (cur <= maxDate) {
        allDateLabels.push( formatYmd(cur) );
        cur.setDate(cur.getDate() + 1);
      }

      // 2) Initialize DataTable
      table = $("#actionsTable").DataTable({
        data: rowData,
        columns: [
          {
            className: "details-control",
            orderable: false,
            data: null,
            defaultContent: `
              <span class="text-primary fw-bold"
                data-bs-toggle="tooltip"
                title="Click to reveal AI Analysis"
              >
                <i class="bi bi-plus-circle"></i>
              </span>
            `
          },
          { data: "title", title: "Title" },
          { data: "topic", title: "AI-Identified Topics" },
          {
            data: "postedSort",
            title: "Posted",
            type: "num",
            render: (val, type, row) => {
              if (type === "sort") return val;
              return row.postedDisplay;
            }
          },
          {
            data: null,
            title: "Link",
            render: (rd, type, row) => {
              if (!row.linkUrl) return "None";
              return `
                <a
                  href="${row.linkUrl}"
                  target="_blank"
                  class="text-decoration-none"
                  data-bs-toggle="tooltip"
                  title="Open the official action on WhiteHouse.gov"
                >
                  <i class="bi bi-box-arrow-up-right"></i> ${row.linkText}
                </a>
              `;
            }
          },
          {
            data: "analysisHidden",
            visible: false,
            searchable: true
          }
        ],
        order: [[3, "desc"]], // newest -> oldest
        responsive: true
      });

      // Collapsible child row
      $("#actionsTable tbody").on("click", "td.details-control", function() {
        const tr = $(this).closest("tr");
        const row = table.row(tr);

        // hide tooltip if open
        const iconEl = this.querySelector("[data-bs-toggle='tooltip']");
        if (iconEl) {
          const tipInst = bootstrap.Tooltip.getInstance(iconEl);
          if (tipInst) tipInst.hide();
        }

        if (row.child.isShown()) {
          row.child.hide();
          tr.removeClass("shown");
          $(this).html(`
            <span class="text-primary fw-bold"
              data-bs-toggle="tooltip"
              title="Click to reveal AI Analysis"
            >
              <i class="bi bi-plus-circle"></i>
            </span>
          `);
        } else {
          row.child(formatChildRow(row.data())).show();
          tr.addClass("shown");
          $(this).html(`
            <span class="text-danger fw-bold"
              data-bs-toggle="tooltip"
              title="Hide AI Analysis"
            >
              <i class="bi bi-dash-circle"></i>
            </span>
          `);
        }
        let tips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tips.map(el => new bootstrap.Tooltip(el));
      });

      // Initialize tooltips
      let tips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tips.map(el => new bootstrap.Tooltip(el));

      // 3) Create locked-axis charts
      dailyChart = createDailyChart(allDateLabels);
      hourChart  = createHourChart(hourLabels);

      // 4) Setup noUiSlider for date/time range
      sliderMin = minTS;
      sliderMax = maxTS;

      // Register custom filter for DataTables
      $.fn.dataTable.ext.search.push((settings, rowData_, dataIndex) => {
        const rowObj = table.row(dataIndex).data();
        const t = rowObj.postedSort;
        return (t >= sliderMin && t <= sliderMax);
      });

      // Create noUiSlider
      const sliderEl = document.getElementById("sliderRange");
      noUiSlider.create(sliderEl, {
        start: [ minTS, maxTS ],
        connect: true,
        step: 60000, // 1-minute increments
        range: {
          min: minTS,
          max: maxTS
        },
        // We'll format the tooltip with "YYYY-MM-DD HH:mm"
        tooltips: [ 
          { to: val => formatUnixDateTime(val), from: val => +val },
          { to: val => formatUnixDateTime(val), from: val => +val }
        ],
      });

      // Listen for 'update' events to get numeric values
      sliderEl.noUiSlider.on('update', (values, handle, unencoded) => {
        // unencoded = raw numeric array
        sliderMin = unencoded[0];
        sliderMax = unencoded[1];

        // Update text
        $("#sliderMin").text( formatUnixDateTime(sliderMin) );
        $("#sliderMax").text( formatUnixDateTime(sliderMax) );

        // Re-filter the table => triggers 'draw' => updates charts
        table.draw();
      });

      // 5) On table draw => recalc aggregator => update charts
      table.on("draw", () => {
        updateChartsFromTable();
      });
      // Initial fill
      updateChartsFromTable();
    })
    .catch(err => console.error("Error fetching JSON:", err));

  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  // Chart creation with locked x-axes
  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  // daily chart => locked date range from earliest..latest
  function createDailyChart(dateLabels) {
    const ctx = document.getElementById("dailyChart").getContext("2d");
    return new Chart(ctx, {
      type: "bar",
      data: {
        labels: dateLabels.slice(),
        datasets: [{
          label: "Actions / Day",
          data: new Array(dateLabels.length).fill(0),
          backgroundColor: "rgba(255, 99, 132, 0.6)",
          borderColor: "rgba(255, 99, 132, 1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: "Date (YYYY-MM-DD)" }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: "Number of Actions" }
          }
        }
      }
    });
  }

  // hour chart => locked 0..23
  function createHourChart(hourArr) {
    const ctx = document.getElementById("hourChart").getContext("2d");
    return new Chart(ctx, {
      type: "bar",
      data: {
        labels: hourArr, // e.g. "0","1","2",...,"23"
        datasets: [{
          label: "Actions by Hour",
          data: new Array(24).fill(0),
          backgroundColor: "rgba(54, 162, 235, 0.6)",
          borderColor: "rgba(54, 162, 235, 1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: "Hour of Day (Local)" }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: "Number of Actions" }
          }
        }
      }
    });
  }

  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  // Re-aggregate from visible rows => update the charts
  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  function updateChartsFromTable() {
    // visible rows
    const displayed = table.rows({ filter: 'applied' }).data();

    // daily aggregator
    let dailyMap = {};
    // hour aggregator
    let hourArr = new Array(24).fill(0);

    displayed.each(item => {
      const dt = new Date(item.postedSort);
      const ymd = formatYmd(dt); 
      dailyMap[ymd] = (dailyMap[ymd] || 0) + 1;

      const hr = dt.getHours();
      hourArr[hr]++;
    });

    // (A) Update dailyChart
    let dailyVals = [];
    dailyChart.data.labels.forEach(dStr => {
      dailyVals.push( dailyMap[dStr] || 0 );
    });
    dailyChart.data.datasets[0].data = dailyVals;
    dailyChart.update();

    // (B) Update hourChart
    hourChart.data.datasets[0].data = hourArr;
    hourChart.update();
  }
</script>
</body>
</html>
