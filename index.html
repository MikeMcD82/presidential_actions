<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Presidential Actions (@M_McDonough Automation Experiment)</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-96WRJNJ5NH"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-96WRJNJ5NH');
  </script>

  <!-- BOOTSTRAP 5 (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />

  <!-- DataTables + Bootstrap Integration (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
  />

  <style>
    /* We’ll show a plus/minus icon in the first column for child-row toggling */
    td.details-control {
      cursor: pointer;
      text-align: center;
    }
    /* Make the toggle column narrower */
    th:nth-child(1), td:nth-child(1) {
      width: 30px;
    }
    /* Hide the invisible "analysis" column from normal display */
    /* (We set visible: false in DataTables config, but optional if you'd like to confirm layout) */
  </style>
</head>
<body class="bg-light">
  <div class="container my-4">
    <h1 class="mb-4 text-center">Presidential Actions (@M_McDonough Automation Experiment)</h1>

    <table
      id="actionsTable"
      class="table table-striped table-hover align-middle"
      style="width:100%"
    >
      <thead>
        <tr>
          <th></th> <!-- plus/minus -->
          <th>Title</th>
          <th>Date</th>
          <th>Link</th>
          <!-- No "Analysis" column here, because we show it as a child row -->
          <!-- But we WILL have a hidden column storing the analysis text for searching -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- BOOTSTRAP 5 (JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- DataTables + Bootstrap Integration (JS) -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
    const DATA_URL = "https://whpresidentialactionsjsons.s3.us-east-1.amazonaws.com/gpt_responses.json";

    function parseCustomDate(str) {
      const timeVal = Date.parse(str);
      return isNaN(timeVal) ? null : timeVal;
    }

    function escapeHtml(str) {
      return str.replace(/[&<>]/g, (tag) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;"
      }[tag] || tag));
    }

    // The function that builds the collapsible child row
    function formatChildRow(d) {
      // d.analysisHidden is the full text for searching, same as d.analysis
      if (!d.analysisHidden) {
        return "<em>No Analysis</em>";
      }

      // We'll re-run the line-break logic, or we can store it pre-formatted
      let safeText = escapeHtml(d.analysisHidden);
      safeText = safeText.replace(/^\s+/, "");             // remove leading whitespace
      safeText = safeText.replace(/\n(\d+\)\s)/g, "$1");   // remove newline if directly before a digit
      safeText = safeText.replace(/\n/g, "<br>");          // replace newlines with <br>
      safeText = safeText.replace(/(\d+\)\s)/g, "<br>$1"); // insert <br> before e.g. "1) "

      return `<strong>AI Analysis:</strong><br>${safeText}`;
    }

    fetch(DATA_URL)
      .then(resp => resp.json())
      .then(data => {
        const rowData = [];

        // Build row data array
        Object.entries(data).forEach(([actionLink, item]) => {
          const dateStr = item.date || "Unknown";
          const dateVal = parseCustomDate(dateStr);

          let linkUrl = null;
          let linkText = "None";
          if (actionLink.startsWith("http")) {
            linkUrl = actionLink;
            linkText = "View";
          }

          rowData.push({
            title: item.title || "Unknown",
            dateStr: dateStr,
            dateVal: dateVal,
            linkUrl: linkUrl,
            linkText: linkText,
            analysisHidden: item.analysis || null
          });
        });

        const table = $("#actionsTable").DataTable({
          data: rowData,
          columns: [
            {
              // the +/- toggler
              className: "details-control",
              orderable: false,
              data: null,
              defaultContent: "<span class='text-primary fw-bold'>+</span>"
            },
            { data: "title" },
            {
              data: "dateStr",
              render: (data, type, row) => {
                // Use numeric dateVal for sorting
                if (type === "sort" && row.dateVal) {
                  return row.dateVal;
                }
                return data;
              }
            },
            {
              data: "linkUrl",
              render: (data, type, row) => {
                if (!data) return "None";
                return `<a href="${data}" target="_blank">${row.linkText}</a>`;
              }
            },
            {
              // hidden column storing the analysis for searching
              data: "analysisHidden",
              visible: false,      // hide column from the UI
              searchable: true     // but include in global search
            }
          ],
          order: [[2, "desc"]], // sort by date column (index=2) descending
          responsive: true
        });

        // Toggle child row
        $("#actionsTable tbody").on("click", "td.details-control", function() {
          const tr = $(this).closest("tr");
          const row = table.row(tr);
          if (row.child.isShown()) {
            row.child.hide();
            tr.removeClass("shown");
            $(this).html("<span class='text-primary fw-bold'>+</span>");
          } else {
            row.child(formatChildRow(row.data())).show();
            tr.addClass("shown");
            $(this).html("<span class='text-danger fw-bold'>–</span>");
          }
        });
      })
      .catch(err => console.error("Error fetching JSON:", err));
  </script>
</body>
</html>
