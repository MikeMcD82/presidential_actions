<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Presidential Actions - A @M_McDonough Experiment</title>

  <!-- BOOTSTRAP 5 (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <!-- DataTables + Bootstrap Integration (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
  />
  <!-- jQuery UI CSS (for the slider) -->
  <link
    rel="stylesheet"
    href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css"
  />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- (Optional) Bootstrap Icons -->
  <link 
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />

  <style>
    /* The first column is for toggling child rows */
    td.details-control {
      cursor: pointer;
      text-align: center;
    }
    th:nth-child(1), td:nth-child(1) {
      width: 60px;
      text-align: center;
    }

    /* Let charts fill their container */
    .chart-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    /* Minimal jQuery UI slider style overrides to look more Bootstrap-ish */
    .ui-slider-horizontal {
      height: 0.4rem;
      border-radius: 0.2rem;
      background: #eee;
    }
    .ui-slider-horizontal .ui-slider-range {
      background: #0d6efd; /* Bootstrap primary color */
      border-radius: 0.2rem;
    }
    .ui-slider-horizontal .ui-slider-handle {
      border: 2px solid #0d6efd;
      background: #fff;
      width: 1.4rem;
      height: 1.4rem;
      border-radius: 50%;
      top: -0.55rem;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body class="bg-light">

<div class="container my-4">
  <h1 class="mb-4 text-center">Presidential Actions - A @M_McDonough Experiment</h1>

  <!-- Date Range Slider Card -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0">Filter by Posting Date</h5>
    </div>
    <div class="card-body">
      <div id="slider-range"></div>
      <div class="mt-2">
        Showing posts from
        <span id="sliderMin" class="fw-bold"></span>
        to
        <span id="sliderMax" class="fw-bold"></span>
      </div>
    </div>
  </div>

  <!-- Main DataTable -->
  <table id="actionsTable" class="table table-striped table-hover align-middle" style="width:100%">
    <thead>
      <tr>
        <th>AI</th>
        <th>Title</th>
        <th>AI-Identified Topics</th>
        <th>Posted</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Two bar charts side by side -->
  <div class="row mt-5">
    <!-- Left column: daily bar chart with locked date axis -->
    <div class="col-md-6 mb-3">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Actions Posted by Day (Filtered)</h5>
        </div>
        <div class="card-body" style="height: 400px;">
          <div class="chart-container">
            <canvas id="dailyChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Right column: hour-of-day chart with 0..23 locked x-axis -->
    <div class="col-md-6 mb-3">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Time of Day Posted (Filtered)</h5>
        </div>
        <div class="card-body" style="height: 400px;">
          <div class="chart-container">
            <canvas id="hourChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BOOTSTRAP 5 (JS) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- jQuery UI JS (for slider) -->
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<!-- DataTables + Bootstrap Integration (JS) -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
  // URL to your JSON
  const DATA_URL = "https://whpresidentialactionsjsons.s3.us-east-1.amazonaws.com/gpt_responses.json";

  // We'll gather data in rowData
  let rowData = [];
  // We'll track the earliest and latest Unix timestamps across all data
  let minTS = Infinity;
  let maxTS = -Infinity;

  // For the daily chart, we want to lock the entire date range from the earliest to latest date:
  let allDateLabels = []; // each "YYYY-MM-DD" from minDate..maxDate

  // For the hour chart, we always lock 24 hours (0..23):
  const hourLabels = [...Array(24).keys()].map(String);

  // We'll store references to our DataTable and charts:
  let table;
  let dailyChart, hourChart;

  // We'll store slider min/max in sliderMin/sliderMax
  let sliderMin, sliderMax;

  // Utility: convert a Unix timestamp to "YYYY-MM-DD HH:mm"
  function formatUnixDateTime(unixTs) {
    const d = new Date(unixTs);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  }

  // We want a "YYYY-MM-DD" from a Date object
  function formatYmd(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, "0");
    const d = String(dateObj.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  // Collapsible child row
  function formatChildRow(d) {
    if (!d.analysisHidden) return "<em>No Analysis</em>";
    let safeText = d.analysisHidden
      .replace(/[&<>]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;" }[c]))
      .replace(/^\s+/, "")
      .replace(/\n(\d+\)\s)/g, "<br>$1")
      .replace(/\n/g, "<br>");
    return `
      <div style="text-align:left;">
        <strong>AI Analysis:</strong><br>
        ${safeText}
      </div>
    `;
  }

  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  //  1) FETCH JSON => BUILD rowData => DETERMINE MIN/MAX => BUILD allDateLabels
  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  fetch(DATA_URL + `?nocache=${Date.now()}`)
    .then(resp => resp.json())
    .then(data => {
      // Build rowData
      Object.entries(data).forEach(([link, item]) => {
        const dt = new Date(item.date_unix);
        const ts = dt.valueOf();
        if (ts < minTS) minTS = ts;
        if (ts > maxTS) maxTS = ts;

        let topicVal = item.topic || "Other";
        // remove "Topical Classification:"
        topicVal = topicVal.replace(/topical classification:\s*/i, "").trim();

        rowData.push({
          title: item.title || "Unknown",
          topic: topicVal,
          postedDisplay: formatUnixDateTime(ts), // for display
          postedSort: ts,                        // numeric
          linkUrl: link.startsWith("http") ? link : null,
          linkText: link.startsWith("http") ? "WH.gov" : "None",
          analysisHidden: item.analysis || null
        });
      });

      // Now build our locked daily date range from earliest -> latest
      // We'll create allDateLabels as an array of "YYYY-MM-DD"
      let minDate = new Date(minTS);
      minDate.setHours(0,0,0,0);
      let maxDate = new Date(maxTS);
      maxDate.setHours(0,0,0,0);

      let cur = new Date(minDate);
      while (cur <= maxDate) {
        allDateLabels.push( formatYmd(cur) );
        cur.setDate(cur.getDate() + 1);
      }

      // 2) Initialize DataTable
      table = $("#actionsTable").DataTable({
        data: rowData,
        columns: [
          {
            className: "details-control",
            orderable: false,
            data: null,
            defaultContent: `
              <span class="text-primary fw-bold"
                data-bs-toggle="tooltip"
                title="Click to reveal AI Analysis"
              >
                <i class="bi bi-plus-circle"></i>
              </span>
            `
          },
          { data: "title", title: "Title" },
          { data: "topic", title: "AI-Identified Topics" },
          {
            data: "postedSort",
            title: "Posted",
            type: "num",
            render: (val, type, row) => {
              if (type === "sort") return val;
              return row.postedDisplay;
            }
          },
          {
            data: null,
            title: "Link",
            render: (rd, type, row) => {
              if (!row.linkUrl) return "None";
              return `
                <a
                  href="${row.linkUrl}"
                  target="_blank"
                  class="text-decoration-none"
                  data-bs-toggle="tooltip"
                  title="Open the official action on WhiteHouse.gov"
                >
                  <i class="bi bi-box-arrow-up-right"></i> ${row.linkText}
                </a>
              `;
            }
          },
          {
            data: "analysisHidden",
            visible: false,
            searchable: true
          }
        ],
        order: [[3, "desc"]],
        responsive: true
      });

      // Collapsible child row
      $("#actionsTable tbody").on("click", "td.details-control", function() {
        const tr = $(this).closest("tr");
        const row = table.row(tr);

        const iconEl = this.querySelector("[data-bs-toggle='tooltip']");
        if (iconEl) {
          const tipInst = bootstrap.Tooltip.getInstance(iconEl);
          if (tipInst) tipInst.hide();
        }

        if (row.child.isShown()) {
          row.child.hide();
          tr.removeClass("shown");
          $(this).html(`
            <span class="text-primary fw-bold"
              data-bs-toggle="tooltip"
              title="Click to reveal AI Analysis"
            >
              <i class="bi bi-plus-circle"></i>
            </span>
          `);
        } else {
          row.child(formatChildRow(row.data())).show();
          tr.addClass("shown");
          $(this).html(`
            <span class="text-danger fw-bold"
              data-bs-toggle="tooltip"
              title="Hide AI Analysis"
            >
              <i class="bi bi-dash-circle"></i>
            </span>
          `);
        }
        let tips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tips.map(el => new bootstrap.Tooltip(el));
      });

      // Initialize tooltips
      let tips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tips.map(el => new bootstrap.Tooltip(el));

      // 3) Create the two locked-axis charts:
      dailyChart = createDailyChart(allDateLabels); // locked x-axis
      hourChart  = createHourChart();               // 24-hour locked x-axis

      // 4) Setup date-range slider with custom filtering
      sliderMin = minTS;
      sliderMax = maxTS;

      // Register the custom filter
      $.fn.dataTable.ext.search.push((settings, rowData_, dataIndex) => {
        const rowObj = table.row(dataIndex).data();
        const t = rowObj.postedSort;
        return (t >= sliderMin && t <= sliderMax);
      });

      // jQuery UI range slider
      $("#slider-range").slider({
        range: true,
        min: minTS,
        max: maxTS,
        values: [minTS, maxTS],
        slide: (evt, ui) => {
          sliderMin = ui.values[0];
          sliderMax = ui.values[1];
          $("#sliderMin").text( formatUnixDateTime(sliderMin).split(" ")[0] );
          $("#sliderMax").text( formatUnixDateTime(sliderMax).split(" ")[0] );
          table.draw(); // re-filter the table => triggers "draw" event
        }
      });
      $("#sliderMin").text( formatUnixDateTime(minTS).split(" ")[0] );
      $("#sliderMax").text( formatUnixDateTime(maxTS).split(" ")[0] );

      // 5) On every table draw => recalc aggregator => update charts
      table.on("draw", function() {
        updateChartsFromTable();
      });

      // Initial chart fill
      updateChartsFromTable();
    })
    .catch(err => console.error("Error:", err));

  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  //  Chart creation with locked x-axes
  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  // (A) daily chart with locked date axis from earliest to latest
  function createDailyChart(allDatesArray) {
    const ctx = document.getElementById("dailyChart").getContext("2d");
    return new Chart(ctx, {
      type: "bar",
      data: {
        // We'll store these date strings as our x-axis categories
        labels: allDatesArray.slice(), // shallow copy
        datasets: [{
          label: "Actions / Day",
          data: new Array(allDatesArray.length).fill(0), // starts at all zeros
          backgroundColor: "rgba(255, 99, 132, 0.6)",
          borderColor: "rgba(255, 99, 132, 1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: "Date (YYYY-MM-DD)" }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: "Number of Actions" }
          }
        }
      }
    });
  }

  // (B) hour chart locked from 0..23
  function createHourChart() {
    const ctx = document.getElementById("hourChart").getContext("2d");
    const hourAxis = [...Array(24).keys()].map(String); // "0","1",...,"23"
    return new Chart(ctx, {
      type: "bar",
      data: {
        labels: hourAxis,
        datasets: [{
          label: "Actions by Hour",
          data: new Array(24).fill(0),
          backgroundColor: "rgba(54, 162, 235, 0.6)",
          borderColor: "rgba(54, 162, 235, 1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: "Hour of Day (Local)" }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: "Number of Actions" }
          }
        }
      }
    });
  }

  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  //  Re-aggregate & update the charts from visible rows
  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  function updateChartsFromTable() {
    // Pull out all the displayed rows
    const displayedRows = table.rows({ filter: 'applied' }).data();

    // (1) Re-aggregate daily
    // We'll build a map: dateKey => count
    let dailyMap = {};
    displayedRows.each(item => {
      const dt = new Date(item.postedSort);
      const dateStr = formatYmd(dt); // e.g. "2025-01-24"
      dailyMap[dateStr] = (dailyMap[dateStr] || 0) + 1;
    });

    // Then we fill an array for allDateLabels in correct order
    let dailyVals = [];
    dailyChart.data.labels.forEach(dayStr => {
      dailyVals.push(dailyMap[dayStr] || 0);
    });
    dailyChart.data.datasets[0].data = dailyVals;
    dailyChart.update();

    // (2) Re-aggregate hours
    let hourArr = new Array(24).fill(0);
    displayedRows.each(item => {
      const hr = new Date(item.postedSort).getHours();
      hourArr[hr]++;
    });
    hourChart.data.datasets[0].data = hourArr;
    hourChart.update();
  }
</script>
</body>
</html>
