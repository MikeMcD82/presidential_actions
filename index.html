<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Presidential Actions (@M_McDonough Automation Experiment)</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-96WRJNJ5NH"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-96WRJNJ5NH');
  </script>

  <!-- BOOTSTRAP 5 (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />

  <!-- Bootstrap Icons (for plus/minus icons) -->
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />

  <!-- DataTables + Bootstrap Integration (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
  />

  <style>
    /* The first column is for toggling child rows */
    td.details-control {
      cursor: pointer;
      text-align: center;
    }
    /* Slightly wider for the "AI" heading and icons */
    th:nth-child(1), td:nth-child(1) {
      width: 60px;
      text-align: center;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container my-4">
    <h1 class="mb-4 text-center">Presidential Actions (@M_McDonough Automation Experiment)</h1>

    <table
      id="actionsTable"
      class="table table-striped table-hover align-middle"
      style="width:100%"
    >
      <thead>
        <tr>
          <th>AI</th> <!-- plus/minus toggle column -->
          <th>Title</th>
          <th>AI-Identified Topics</th> <!-- RENAMED column header -->
          <th>Date</th>
          <th>Link</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- BOOTSTRAP 5 (JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- DataTables + Bootstrap Integration (JS) -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
    const DATA_URL = "https://whpresidentialactionsjsons.s3.us-east-1.amazonaws.com/gpt_responses.json";

    // Parse a date string like "January 24, 2025 at 08:09 PM" into numeric time
    function parseCustomDate(str) {
      const timeVal = Date.parse(str);
      return isNaN(timeVal) ? null : timeVal;
    }

    // Escape HTML before inserting <br>
    function escapeHtml(str) {
      return str.replace(/[&<>]/g, (tag) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;"
      }[tag] || tag));
    }

    // Build the collapsible child row with the AI Analysis, left-aligned
    function formatChildRow(d) {
      if (!d.analysisHidden) {
        return "<em>No Analysis</em>";
      }
      let safeText = escapeHtml(d.analysisHidden);
      // Remove leading whitespace
      safeText = safeText.replace(/^\s+/, "");
      // Remove newline if it's right before a digit pattern
      safeText = safeText.replace(/\n(\d+\)\s)/g, "$1");
      // Convert remaining newlines to <br>
      safeText = safeText.replace(/\n/g, "<br>");
      // Insert <br> before something like "1) "
      safeText = safeText.replace(/(\d+\)\s)/g, "<br>$1");

      // Wrap in a <div style="text-align: left;"> so it's left-aligned
      return `
        <div style="text-align: left;">
          <strong>AI Analysis:</strong><br>
          ${safeText}
        </div>
      `;
    }

    fetch(DATA_URL)
      .then(resp => resp.json())
      .then(data => {
        const rowData = [];

        // Convert the dictionary from S3 into an array for DataTables
        Object.entries(data).forEach(([actionLink, item]) => {
          const dateStr = item.date || "Unknown";
          const dateVal = parseCustomDate(dateStr);

          let linkUrl = null;
          let linkText = "None";
          if (actionLink.startsWith("http")) {
            linkUrl = actionLink;
            linkText = "WH.gov";
          }

          // If "topic" not present, fallback to "Other"
          let topicVal = item.topic || "Other";

          // Drop "Topical Classification: " ignoring case
          topicVal = topicVal.replace(/topical classification:\s*/i, "").trim();

          rowData.push({
            title: item.title || "Unknown",
            topic: topicVal,
            dateStr: dateStr,
            dateVal: dateVal,
            linkUrl: linkUrl,
            linkText: linkText,
            analysisHidden: item.analysis || null
          });
        });

        const table = $("#actionsTable").DataTable({
          data: rowData,
          columns: [
            {
              className: "details-control",
              orderable: false,
              data: null,
              // We use a plus-circle icon with a tooltip
              defaultContent: `
                <span class="text-primary fw-bold"
                  data-bs-toggle="tooltip" 
                  data-bs-placement="top"
                  title="Click to reveal AI Analysis"
                >
                  <i class="bi bi-plus-circle"></i>
                </span>
              `
            },
            { data: "title", title: "Title" },
            { 
              data: "topic",
              title: "AI-Identified Topics",
              render: (data) => data || "Other" 
            },
            {
              data: "dateStr",
              title: "Date",
              render: (data, type, row) => {
                // Use numeric dateVal for sorting
                if (type === "sort" && row.dateVal) {
                  return row.dateVal;
                }
                return data;
              }
            },
            {
              data: "linkUrl",
              title: "Link",
              render: (data, type, row) => {
                if (!data) return "None";
                // A small icon + "WH.gov" link
                // with a tooltip saying "Open on WhiteHouse.gov"
                return `
                  <a 
                    href="${data}" 
                    target="_blank" 
                    class="text-decoration-none"
                    data-bs-toggle="tooltip"
                    title="Open the official action on WhiteHouse.gov"
                  >
                    <i class="bi bi-box-arrow-up-right"></i> ${row.linkText}
                  </a>
                `;
              }
            },
            {
              // Hidden column storing the analysis for searching
              data: "analysisHidden",
              visible: false,
              searchable: true
            }
          ],
          order: [[3, "desc"]],  // sort by date column (index=3) descending
          responsive: true
        });

        // Expand/collapse child rows on clicking the first cell
        $("#actionsTable tbody").on("click", "td.details-control", function() {
          const tr = $(this).closest("tr");
          const row = table.row(tr);

          // Force-hide any tooltip on this icon so it doesn't get stuck
          const iconEl = this.querySelector("[data-bs-toggle='tooltip']");
          if (iconEl) {
            const tooltipInstance = bootstrap.Tooltip.getInstance(iconEl);
            if (tooltipInstance) {
              tooltipInstance.hide();
            }
          }

          if (row.child.isShown()) {
            // Hide child row
            row.child.hide();
            tr.removeClass("shown");
            // Revert the icon back to plus
            $(this).html(`
              <span class="text-primary fw-bold"
                data-bs-toggle="tooltip" 
                title="Click to reveal AI Analysis"
              >
                <i class="bi bi-plus-circle"></i>
              </span>
            `);
          } else {
            // Show child row with the AI analysis
            row.child(formatChildRow(row.data())).show();
            tr.addClass("shown");
            // Switch icon to minus
            $(this).html(`
              <span class="text-danger fw-bold"
                data-bs-toggle="tooltip"
                title="Hide AI Analysis"
              >
                <i class="bi bi-dash-circle"></i>
              </span>
            `);
          }

          // Re-initialize Bootstrap tooltips for newly-added elements
          var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
          });
        });

        // Initialize all tooltips (the ones in the table header, etc.)
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      })
      .catch(err => console.error("Error fetching JSON:", err));
  </script>
</body>
</html>
