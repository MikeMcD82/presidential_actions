<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Presidential Actions (@M_McDonough Automation Experiment)</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-96WRJNJ5NH"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-96WRJNJ5NH');
  </script>

  <!-- BOOTSTRAP 5 (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />

  <!-- DataTables + Bootstrap Integration (CSS) -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
  />

  <style>
    /* We’ll show a plus/minus icon in the first column for child-row toggling */
    td.details-control {
      cursor: pointer;
      text-align: center;
    }

    /* Make the toggle column narrower */
    th:nth-child(1),
    td:nth-child(1) {
      width: 30px;
    }

    /* Adjust layout if needed; 
       the actual child row details use a built-in DataTables class .child */
  </style>
</head>
<body class="bg-light">

  <div class="container my-4">
    <h1 class="mb-4 text-center">Presidential Actions (@M_McDonough Automation Experiment)</h1>

    <!-- The main table -->
    <table
      id="actionsTable"
      class="table table-striped table-hover align-middle"
      style="width:100%"
    >
      <thead>
        <tr>
          <th></th> <!-- for the +/- icon -->
          <th>Title</th>
          <th>Date</th>
          <th>Link</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- BOOTSTRAP 5 (JS) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- DataTables + Bootstrap Integration (JS) -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
    // Replace with your publicly accessible S3 URL for the dictionary JSON
    const DATA_URL = "https://whpresidentialactionsjsons.s3.us-east-1.amazonaws.com/gpt_responses.json";

    // Parse date strings like "January 24, 2025 at 08:09 PM" into numeric time
    function parseCustomDate(str) {
      const timeVal = Date.parse(str);
      return isNaN(timeVal) ? null : timeVal;
    }

    // Escape HTML before inserting <br>
    function escapeHtml(str) {
      return str.replace(/[&<>]/g, (tag) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;"
      }[tag] || tag));
    }

    // Format the child row: we’ll show the "AI Analysis" here
    // d parameter is our row data object
    function formatChildRow(d) {
      if (!d.analysis) {
        return '<em>No Analysis</em>';
      }
      let safeText = escapeHtml(d.analysis);
      // Remove leading whitespace
      safeText = safeText.replace(/^\s+/, "");
      // Remove newline if it's directly before a digit pattern
      safeText = safeText.replace(/\n(\d+\)\s)/g, "$1");
      // Replace all remaining newlines with <br>
      safeText = safeText.replace(/\n/g, "<br>");
      // Insert a single <br> before each "digit + ) + space"
      safeText = safeText.replace(/(\d+\)\s)/g, "<br>$1");

      return `<strong>AI Analysis:</strong><br>${safeText}`;
    }

    // We'll store row data objects like:
    // {
    //   title: ...,
    //   dateStr: ...,
    //   dateVal: ...,
    //   linkUrl: ...,
    //   analysis: ...
    // }
    const rowDataArray = [];

    // Step 1: Fetch JSON from S3
    fetch(DATA_URL)
      .then(resp => resp.json())
      .then(data => {
        // data is an object/dict => use Object.entries
        // each entry => [actionLink, item]
        Object.entries(data).forEach(([actionLink, item]) => {
          const dateStr = item.date || "Unknown";
          const dateVal = parseCustomDate(dateStr);

          // Derive link text
          let linkText = "None";
          let linkUrl = null;
          if (actionLink.startsWith("http")) {
            linkText = "View";
            linkUrl = actionLink;
          }

          rowDataArray.push({
            title: item.title || "Unknown",
            dateStr: dateStr,
            dateVal: dateVal,
            linkUrl: linkUrl,
            linkText: linkText,
            analysis: item.analysis || null
          });
        });

        // Step 2: Initialize DataTable
        // We'll have 4 columns:
        // [0] = toggler icon
        // [1] = Title
        // [2] = Date
        // [3] = Link
        const table = $("#actionsTable").DataTable({
          data: rowDataArray,
          columns: [
            {
              // For the plus/minus icon
              className: "details-control",
              orderable: false,
              data: null,
              defaultContent: "<span class='text-primary fw-bold'>+</span>"
            },
            { data: "title" },
            {
              data: "dateStr",
              // We’ll let dateVal be used for sorting
              render: function(data, type, row) {
                // data is "dateStr"
                if (type === "sort" && row.dateVal !== null) {
                  // Use dateVal for sorting
                  return row.dateVal;
                }
                // else display dateStr
                return data;
              }
            },
            {
              data: "linkUrl",
              render: function(data, type, row) {
                if (!data) return "None";
                return `<a href="${data}" target="_blank">${row.linkText}</a>`;
              }
            }
          ],
          order: [[2, "desc"]], // dateStr col is index 2
          // Use Bootstrap styling
          responsive: true
        });

        // Step 3: Add event listener for opening/closing child rows
        // Inspired by https://datatables.net/examples/api/row_details.html
        $("#actionsTable tbody").on("click", "td.details-control", function() {
          const tr = $(this).closest("tr");
          const row = table.row(tr);

          if (row.child.isShown()) {
            // This row is already open => close it
            row.child.hide();
            tr.removeClass("shown");
            $(this).html("<span class='text-primary fw-bold'>+</span>");
          } else {
            // Open this row => show AI analysis as child row
            row.child(formatChildRow(row.data())).show();
            tr.addClass("shown");
            $(this).html("<span class='text-danger fw-bold'>–</span>");
          }
        });
      })
      .catch(err => {
        console.error("Error fetching JSON:", err);
      });
  </script>
</body>
</html>
